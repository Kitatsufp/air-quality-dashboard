<!DOCTYPE html>
<html>

<head>
    <title>Air Quality Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<h1 style="color:red;">TEST 123</h1>

<body>

    <div class="layout">

        <!-- SIDEBAR -->
        <div class="sidebar">
            <h2>üåç AQI</h2>
            <p>Dashboard</p>
        </div>

        <!-- MAIN -->
        <div class="main">

            <div class="header">
                <h1>Air Quality Dashboard</h1>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>

            <!-- LOGIN -->
            <div id="login-section" class="card center">
                <h3>Login</h3>
                <input id="username" placeholder="Username">
                <input id="password" type="password" placeholder="Password">
                <button class="btn-primary" onclick="login()">Login</button>
                <p id="status"></p>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" style="display:none;">

                <div class="controls card">
                    <div>
                        <label>üìÖ Ch·ªçn ng√†y:</label>
                        <input type="date" id="datePicker">
                        <button class="btn-primary" onclick="fetchData()">Load</button>
                    </div>
                </div>

                <div class="card">
                    <canvas id="chart"></canvas>
                </div>

            </div>

        </div>

    </div>

    <script>
        let chart;

        async function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            const formData = new URLSearchParams();
            formData.append("username", username);
            formData.append("password", password);

            const res = await fetch("https://fastapi-web-3.onrender.com/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData
            });

            const data = await res.json();

            if (data.access_token) {
                localStorage.setItem("token", data.access_token);
                document.getElementById("login-section").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                setToday();
                fetchData();
            } else {
                document.getElementById("status").innerText = "Login failed!";
            }
        }

        function logout() {
            localStorage.removeItem("token");
            document.getElementById("dashboard").style.display = "none";
            document.getElementById("login-section").style.display = "block";
        }

        function setToday() {
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("datePicker").value = today;
        }

        async function fetchData() {
            const token = localStorage.getItem("token");
            if (!token) return;

            const selectedDate = document.getElementById("datePicker").value;

            const res = await fetch(
                `https://fastapi-web-3.onrender.com/blog/daily?target_date=${selectedDate}`,
                {
                    headers: { "Authorization": `Bearer ${token}` }
                }
            );

            const data = await res.json();

            const labels = data.map(d => d.time);
            const values = data.map(d => d.air_quality);

            if (!chart) {
                chart = new Chart(document.getElementById("chart"), {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Air Quality",
                            data: values,
                            borderWidth: 3,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            } else {
                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.update();
            }
        }

        if (localStorage.getItem("token")) {
            document.getElementById("login-section").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            setToday();
            fetchData();
        }
    </script>

</body>

</html>